<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>麻将记分 Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app">
        <!-- 顶部栏 -->
        <header class="header">
            <div class="round-badge" @click="showRoundModal">
                第 {{ currentRound }} 局
            </div>
            <div class="header-actions">
                <button class="icon-btn" @click="adjustScale(-1)" :class="{ disabled: !canZoomOut }">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="icon-btn" @click="adjustScale(1)" :class="{ disabled: !canZoomIn }">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="icon-btn" @click="toggleTheme">
                    <i class="fas" :class="isDark ? 'fa-sun' : 'fa-moon'"></i>
                </button>
                <button class="icon-btn" @click="showStats">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="icon-btn" @click="showHistory">
                    <i class="fas fa-history"></i>
                </button>
                <button class="icon-btn" @click="showSettings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <!-- 游戏主区域 -->
        <main class="game-area">
            <!-- 骰子模式遮罩 -->
            <div class="dice-overlay" :class="{ show: diceMode }" @click="closeDiceMode"></div>

            <!-- 中间转盘 -->
            <div class="center-dial" 
                 :class="{ 
                     'dice-mode': diceMode,
                     'is-rolling': diceMode && isRolling,
                     'roll-finished': diceMode && !isRolling && hasRolled
                 }"
                 :style="{ 
                     transform: diceMode ? '' : `rotate(${dialRotation}deg) scale(${globalScale})` 
                 }"
                 @click="handleDialClick">
                <!-- 只有当该方向对应的是东(dealerIndex)时才高亮 -->
                <div class="direction dir-0 is-east">東</div>
                <div class="direction dir-1">南</div>
                <div class="direction dir-2">西</div>
                <div class="direction dir-3">北</div>
                
                <!-- 数字直接显示，跟随父容器旋转，正对庄家 -->
                <div class="dial-round">{{ currentRound }}</div>

                <!-- 骰子容器 -->
                <div class="dice-container">
                    <div class="dice-box" :style="diceStyles[0]">
                        <div class="dice-face face-1"></div>
                        <div class="dice-face face-2"></div>
                        <div class="dice-face face-3"></div>
                        <div class="dice-face face-4"></div>
                        <div class="dice-face face-5"></div>
                        <div class="dice-face face-6"></div>
                    </div>
                    <div class="dice-box" :style="diceStyles[1]">
                        <div class="dice-face face-1"></div>
                        <div class="dice-face face-2"></div>
                        <div class="dice-face face-3"></div>
                        <div class="dice-face face-4"></div>
                        <div class="dice-face face-5"></div>
                        <div class="dice-face face-6"></div>
                    </div>
                </div>
            </div>

            <!-- 玩家卡片 -->
            <div v-for="(seat, index) in seats" :key="index" 
                 class="player-card" 
                 :class="[
                     `pos-${index}`, 
                     { dealer: dealerIndex === index },
                     { dragging: dragState.dragging && dragState.fromIndex === index && !dragState.draggingNextRound },
                     { 'drag-over': dragState.overIndex === index && (dragState.fromIndex !== index || dragState.draggingNextRound) && (seat || dragState.draggingNextRound) },
                     { 'empty-seat': !seat }
                 ]"
                 :style="{ '--scale-factor': globalScale }"
                 :draggable="seat ? true : false"
                 @click="handleSeatClick(index)"
                 @dragstart="handleDragStart(index, $event)"
                 @dragend="handleDragEnd"
                 @dragover="handleDragOver(index, $event)"
                 @dragleave="handleDragLeave"
                 @drop="handleDrop(index, $event)"
                 @touchstart="handleTouchStart(index, $event)"
                 @touchmove="handleTouchMove($event)"
                 @touchend="handleTouchEnd($event)">
                <!-- 庄家标记 -->
                <div v-if="dealerIndex === index && seat" class="dealer-badge">
                    <i v-if="dealerStreak === 0" class="fas fa-crown"></i>
                    <span v-else>{{ dealerStreak }}</span>
                </div>
                
                <div v-if="seat" style="width: 100%; text-align: center;">
                    <div class="player-name">{{ seat }}</div>
                    <div class="player-score">
                        <count-up :to="getPlayerScore(seat)"></count-up>
                    </div>
                    <div class="score-diff">
                        <span v-if="lastDiff[seat]" :class="lastDiff[seat] > 0 ? 'diff-pos' : 'diff-neg'">
                            {{ lastDiff[seat] > 0 ? '+' : '' }}{{ lastDiff[seat] }}
                        </span>
                    </div>
                </div>
                <div v-else style="opacity: 0.5; font-style: italic;">
                    <i class="fas fa-plus-circle" style="margin-bottom: 8px; font-size: 24px;"></i>
                    <div>入座</div>
                </div>
            </div>
        </main>

        <!-- 底部操作栏 -->
        <footer class="action-bar">
            <button class="btn btn-warning" @click="undo" :disabled="history.length === 0" :style="{ opacity: history.length ? 1 : 0.5 }">
                <i class="fas fa-undo"></i> 撤销
            </button>
            <button 
                class="btn btn-secondary next-round-btn" 
                :class="{ dragging: dragState.draggingNextRound }"
                draggable="true"
                @click="handleNextRoundClick"
                @dragstart="handleNextRoundDragStart"
                @dragend="handleNextRoundDragEnd"
                @touchstart="handleNextRoundTouchStart"
                @touchmove="handleNextRoundTouchMove"
                @touchend="handleNextRoundTouchEnd"
                style="flex: 1; justify-content: center;">
                下一局 <i class="fas fa-chevron-right"></i>
            </button>
        </footer>

        <!-- 模态框组件 -->
        
        <!-- 1. 结算模态框 -->
        <div class="modal-overlay settle-modal-overlay" :class="{ show: modals.settle }" @click="closeModal('settle')">
            <div class="modal-card" @click.stop>
                <div class="modal-title">结算分数</div>
                
                <div class="settle-grid">
                    <div class="player-select-box" 
                         :class="{ 
                             selected: settleFrom, 
                             highlighting: isSelecting && selectingFrom,
                             error: errorFrom
                         }" 
                         @click="handleSelectBoxClick(true)">
                        <span :class="{ 'placeholder-text': !settleFrom, 'player-name-text': settleFrom }">
                            {{ settleFrom || '谁给分数?' }}
                        </span>
                    </div>
                    <i class="fas fa-arrow-right arrow-icon"></i>
                    <div class="player-select-box" 
                         :class="{ 
                             selected: settleTo, 
                             highlighting: isSelecting && !selectingFrom,
                             error: errorTo
                         }" 
                         @click="handleSelectBoxClick(false)">
                        <span :class="{ 'placeholder-text': !settleTo, 'player-name-text': settleTo }">
                            {{ settleTo || '给谁?' }}
                        </span>
                    </div>
                </div>

                <!-- 玩家选择列表 -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px;">
                    <div v-for="p in activePlayers" :key="p" 
                         class="list-item" 
                         :class="{ active: (selectingFrom ? settleFrom : settleTo) === p }"
                         style="justify-content: center; margin: 0;"
                         @click="selectSettlePlayer(p)">
                        {{ p }}
                    </div>
                </div>

                <!-- Calculator Display -->
                <div class="calc-display" :class="{ 'has-value': settleAmount }">
                    <span class="amount-value">{{ settleAmount || '0' }}</span>
                    <button v-if="settleAmount" class="clear-btn" @click="settleAmount = ''">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>

                <!-- Numeric Keypad -->
                <div class="numeric-keypad">
                    <button class="key-btn" @click="appendNumber(1)">1</button>
                    <button class="key-btn" @click="appendNumber(2)">2</button>
                    <button class="key-btn" @click="appendNumber(3)">3</button>
                    <button class="key-btn" @click="appendNumber(4)">4</button>
                    <button class="key-btn" @click="appendNumber(5)">5</button>
                    <button class="key-btn" @click="appendNumber(6)">6</button>
                    <button class="key-btn" @click="appendNumber(7)">7</button>
                    <button class="key-btn" @click="appendNumber(8)">8</button>
                    <button class="key-btn" @click="appendNumber(9)">9</button>
                    <button class="key-btn key-cancel" @click="closeModal('settle')">取消</button>
                    <button class="key-btn" @click="appendNumber(0)">0</button>
                    <button class="key-btn key-delete" @click="backspaceNumber"><i class="fas fa-backspace"></i></button>
                    <button class="key-btn key-confirm" @click="confirmSettle">确认</button>
                </div>
            </div>
        </div>

        <!-- 2. 选人入座模态框 -->
        <div class="modal-overlay" :class="{ show: modals.seat }" @click="closeModal('seat')">
            <div class="modal-card" @click.stop>
                <div class="modal-title">选择玩家入座</div>
                <div class="input-field" style="display: flex; gap: 8px; padding: 4px; border: none; background: transparent;">
                    <input v-model="newPlayerName" class="input-field" placeholder="新玩家名字" style="margin: 0;" @keyup.enter="addNewPlayer">
                    <button class="btn btn-primary" @click="addNewPlayer" style="padding: 0 16px;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <div v-for="p in availablePlayers" :key="p.name" class="list-item" @click="sitDown(p.name)">
                        <span>{{ p.name }}</span>
                        <span style="font-weight: bold;">{{ p.score }}</span>
                    </div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 16px;" @click="closeModal('seat')">取消</button>
            </div>
        </div>

        <!-- 3. 历史记录模态框 -->
        <div class="modal-overlay" :class="{ show: modals.history }" @click="closeModal('history')">
            <div class="modal-card" @click.stop>
                <div class="modal-title">历史记录</div>
                <div v-if="history.length === 0" style="text-align: center; opacity: 0.5; padding: 20px;">暂无记录</div>
                <div v-else style="max-height: 400px; overflow-y: auto;">
                    <div v-for="(h, i) in history" :key="i" class="history-item">
                        <div class="history-meta">
                            <span>第 {{ h.round }} 局</span>
                            <span>{{ formatTime(h.time) }}</span>
                        </div>
                        <div v-for="(t, ti) in h.transactions" :key="ti" class="history-trans">
                            {{ t.from }} <i class="fas fa-arrow-right" style="font-size: 10px; opacity: 0.5;"></i> {{ t.to }} : 
                            <span class="trans-amount">{{ t.amount }}</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" @click="closeModal('history')">
                    <i class="fas fa-check"></i> 关闭
                </button>
            </div>
        </div>

        <!-- 4. 统计图表模态框 -->
        <div class="modal-overlay" :class="{ show: modals.stats }" @click="closeModal('stats')">
            <div class="modal-card" style="max-width: 600px; width: 95%;" @click.stop>
                <div class="modal-title">分数走势</div>
                <div class="chart-container">
                    <canvas id="scoreChart"></canvas>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" @click="closeModal('stats')">
                    <i class="fas fa-check"></i> 关闭
                </button>
            </div>
        </div>

        <!-- 5. 设置模态框 -->
        <div class="modal-overlay" :class="{ show: modals.settings }" @click="closeModal('settings')">
            <div class="modal-card" @click.stop>
                <div class="modal-title">设置</div>
                
                <!-- 操作说明 -->
                <div class="help-section">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                        <span>操作说明</span>
                    </div>
                    <div style="font-size: 14px; line-height: 1.6; opacity: 0.8;">
                        <div style="margin-bottom: 8px;">
                            <strong>💰 结算分数：</strong>拖动玩家A到玩家B，输入分数后确认（A给B分数）
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>👑 指定初始庄家：</strong>在未坐满前，拖动"下一局"到任意位置指定初始庄家（不增加局数）
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>🎲 指定庄家：</strong>游戏中，拖动"下一局"到玩家身上进行换庄或连庄
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>🔄 自动换庄：</strong>点击"下一局"按钮，自动换庄到下一家并进入下一局
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>🎲 打骰子：</strong>点击中间圆盘进入骰子模式，再次点击进行掷骰子
                        </div>
                        <div>
                            <strong>↩️ 撤销操作：</strong>点击"撤销"按钮可撤销上一次结算
                        </div>
                    </div>
                </div>
                
                <div class="list-item" @click="showOriginSet" style="cursor: pointer;">
                    <span><i class="fas fa-crosshairs" style="margin-right: 8px;"></i> 设置原点</span>
                </div>
                
                <div class="list-item" @click="clearData" style="color: var(--danger); cursor: pointer;">
                    <span><i class="fas fa-trash-alt" style="margin-right: 8px;"></i> 清空所有数据</span>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" @click="closeModal('settings')">
                    <i class="fas fa-check"></i> 关闭
                </button>
            </div>
        </div>

        <!-- 6. 手动调庄模态框 -->
        <div class="modal-overlay" :class="{ show: modals.dealerSet }" @click="closeModal('dealerSet')">
            <div class="modal-card" @click.stop>
                <div class="modal-title">指定庄家</div>
                <!-- Vue 3 fix: v-if has higher priority than v-for, so we cannot use seat in v-if on the same element -->
                <template v-for="(s, i) in seats" :key="i">
                    <div v-if="s"
                         class="list-item" 
                         :class="{ active: dealerIndex === i }"
                         @click="setDealer(i)">
                        <span>{{ s }}</span>
                        <span v-if="dealerIndex === i"><i class="fas fa-check"></i></span>
                    </div>
                </template>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 16px;" @click="closeModal('dealerSet')">取消</button>
            </div>
        </div>

        <!-- 7. 设置原点模态框 -->
        <div class="modal-overlay" :class="{ show: modals.originSet }" @click="closeModal('originSet')">
            <div class="modal-card" @click.stop>
                <div class="modal-title">设置原点</div>
                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 16px; text-align: center;">
                    设置每个玩家的起始分数（原点）
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <div v-for="p in players" :key="p.name" class="origin-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">{{ p.name }}</span>
                            <span style="font-size: 12px; opacity: 0.6;">
                                当前分数: {{ getPlayerScore(p.name) }} 
                                <span v-if="p.origin && p.origin !== 0" style="color: var(--primary);">
                                    (原点: {{ p.origin }})
                                </span>
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input 
                                type="number" 
                                class="input-field" 
                                style="flex: 1; margin: 0;"
                                :value="p.origin || 0"
                                @input="updateOrigin(p.name, $event.target.value)"
                                placeholder="起始分数">
                            <button 
                                class="btn btn-secondary" 
                                style="padding: 8px 16px;"
                                @click="setOriginToZero(p.name)">
                                清零
                            </button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" @click="closeModal('originSet')">
                    <i class="fas fa-check"></i> 完成
                </button>
            </div>
        </div>


    </div>

    <script src="js/main.js" type="module"></script>
</body>
</html>