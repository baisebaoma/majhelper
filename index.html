<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€šç”¨éº»å°†è®¡åˆ†å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            height: 100vh;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            display: none;
        }

        .round-info {
            display: none;
        }

        .game-board {
            position: relative;
            flex: 1;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            margin: 0;
            padding: 10px;
            overflow: hidden;
        }

        .seat {
            position: absolute;
            width: 30vw;
            max-width: 200px;
            min-width: 140px;
            text-align: center;
            background: white;
            border-radius: 15px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .seat.bottom:hover {
            transform: translateX(-50%) scale(1.05);
        }

        .seat.top:hover {
            transform: translateX(-50%) rotate(180deg) scale(1.05);
        }

        .seat.left:hover {
            transform: translateY(-50%) rotate(90deg) scale(1.05);
        }

        .seat.right:hover {
            transform: translateY(-50%) rotate(-90deg) scale(1.05);
        }

        .seat.dealer {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
        }

        .seat.dealer::before {
            content: '';
            position: absolute;
            background: transparent;
            color: white;
            width: 0;
            height: 0;
            border-radius: 0;
            font-size: 0;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
        }

        .seat.bottom.dealer::before {
            top: -12px;
            right: -12px;
        }

        .seat.top.dealer::before {
            bottom: -12px;
            left: -12px;
        }

        .seat.left.dealer::before {
            top: -12px;
            left: -12px;
        }

        .seat.right.dealer::before {
            bottom: -12px;
            right: -12px;
        }

        .seat.bottom {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .seat.top {
            top: 10px;
            left: 50%;
            transform: translateX(-50%) rotate(180deg);
        }

        .seat.left {
            left: 10px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
        }

        .seat.right {
            right: 10px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }

        .seat-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .seat-score {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .round-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
            z-index: 10;
        }
        
        .round-center .round-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            text-align: center;
        }
        
        .direction-mark {
            position: absolute;
            font-size: 60px;
            font-weight: bold;
            color: #667eea;
            z-index: 5;
            pointer-events: none;
        }
        
        .direction-mark.bottom {
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 140px);
        }
        
        .direction-mark.top {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -140px) rotate(180deg);
        }
        
        .direction-mark.left {
            left: 50%;
            top: 50%;
            transform: translate(-140px, -50%) rotate(90deg);
        }
        
        .direction-mark.right {
            right: 50%;
            top: 50%;
            transform: translate(140px, -50%) rotate(-90deg);
        }

        .button-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            padding: 8px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 80px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary.blue {
            background: #667eea;
        }
        
        .btn-secondary.blue:hover {
            background: #5568d3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 95%;
            max-width: 500px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .player-list {
            margin-bottom: 20px;
        }

        .player-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .player-item:hover {
            background: #edf2f7;
            border-color: #667eea;
        }

        .player-item.selected {
            background: #667eea;
            color: white;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .settlement-area {
            margin-top: 20px;
        }

        .settlement-item {
            background: #f7fafc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .settlement-item .from-to {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .settlement-item .amount {
            font-size: 18px;
            color: #667eea;
        }

        .settlement-item .remove {
            float: right;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .draggable {
            cursor: grab;
        }

        .draggable:active {
            cursor: grabbing;
        }

        .drop-zone {
            border: 2px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .empty-seat {
            color: #999;
            font-style: italic;
        }

        .settings-list {
            margin-bottom: 20px;
        }

        .settings-item {
            padding: 15px;
            margin-bottom: 12px;
            background: #f7fafc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid #667eea;
        }

        .settings-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }

        .settings-item-content {
            display: flex;
            flex-direction: column;
        }

        .settings-item-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .settings-item-desc {
            font-size: 12px;
            color: #666;
        }

        @media (orientation: landscape) {
            .game-board {
                padding: 8px;
            }
            
            .seat {
                width: 25vw;
                max-width: 220px;
                min-width: 160px;
                padding: 20px;
            }
            
            .seat-name {
                font-size: 20px;
                margin-bottom: 10px;
            }
            
            .seat-score {
                font-size: 36px;
            }
            
            .round-center {
                width: 120px;
                height: 120px;
            }
            
            .round-center .round-number {
                font-size: 22px;
            }
            
            .direction-mark {
                font-size: 56px;
            }
            
            .direction-mark.bottom {
                transform: translate(-50%, 120px);
            }
            
            .direction-mark.top {
                transform: translate(-50%, -120px) rotate(180deg);
            }
            
            .direction-mark.left {
                transform: translate(-120px, -50%) rotate(90deg);
            }
            
            .direction-mark.right {
                transform: translate(120px, -50%) rotate(-90deg);
            }
            
            .seat.bottom {
                bottom: 8px;
            }
            
            .seat.top {
                top: 8px;
            }
            
            .seat.left {
                left: 8px;
            }
            
            .seat.right {
                right: 8px;
            }
            
            .button-group {
                padding: 6px;
                gap: 6px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
                min-width: 80px;
            }
        }
        
        /* é’ˆå¯¹æ¨ªå±ä¸”å®½åº¦è¾ƒå¤§çš„æƒ…å†µè¿›ä¸€æ­¥ä¼˜åŒ– */
        @media (orientation: landscape) and (min-width: 800px) {
            .seat {
                width: 28vw;
                max-width: 250px;
                min-width: 180px;
                padding: 24px;
            }
            
            .seat-name {
                font-size: 24px;
                margin-bottom: 12px;
            }
            
            .seat-score {
                font-size: 42px;
            }
            
            .round-center {
                width: 140px;
                height: 140px;
            }
            
            .round-center .round-number {
                font-size: 26px;
            }
            
            .direction-mark {
                font-size: 64px;
            }
            
            .direction-mark.bottom {
                transform: translate(-50%, 140px);
            }
            
            .direction-mark.top {
                transform: translate(-50%, -140px) rotate(180deg);
            }
            
            .direction-mark.left {
                transform: translate(-140px, -50%) rotate(90deg);
            }
            
            .direction-mark.right {
                transform: translate(140px, -50%) rotate(-90deg);
            }
        }
    </style>
</head>
<body>
        <div class="container">
        <div class="game-board">
            <div class="round-center" id="roundCenter">
                <div class="round-number" id="roundNumberText">ç¬¬ <span id="roundNumber">1</span> å±€</div>
            </div>
            <div class="direction-mark bottom" id="direction-0"></div>
            <div class="direction-mark right" id="direction-1"></div>
            <div class="direction-mark top" id="direction-2"></div>
            <div class="direction-mark left" id="direction-3"></div>
            <div class="seat bottom" data-seat="0" id="seat-0">
                <div class="seat-name" id="name-0">ç‚¹å‡»è®¾ç½®ç©å®¶</div>
                <div class="seat-score" id="score-0">0</div>
            </div>
            <div class="seat right" data-seat="1" id="seat-1">
                <div class="seat-name" id="name-1">ç‚¹å‡»è®¾ç½®ç©å®¶</div>
                <div class="seat-score" id="score-1">0</div>
            </div>
            <div class="seat top" data-seat="2" id="seat-2">
                <div class="seat-name" id="name-2">ç‚¹å‡»è®¾ç½®ç©å®¶</div>
                <div class="seat-score" id="score-2">0</div>
            </div>
            <div class="seat left" data-seat="3" id="seat-3">
                <div class="seat-name" id="name-3">ç‚¹å‡»è®¾ç½®ç©å®¶</div>
                <div class="seat-score" id="score-3">0</div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="settleBtn">ç»“ç®—</button>
            <button class="btn btn-secondary" id="nextRoundBtn">ä¸‹ä¸€å±€</button>
            <button class="btn btn-secondary blue" id="settingsBtn">è®¾ç½®</button>
        </div>
    </div>

    <!-- é€‰æ‹©ç©å®¶æ¨¡æ€æ¡† -->
    <div class="modal" id="playerSelectModal">
        <div class="modal-content">
            <div class="modal-title">é€‰æ‹©ç©å®¶</div>
            <div class="player-list" id="playerList"></div>
            <div class="input-group">
                <label>æ·»åŠ æ–°ç©å®¶</label>
                <input type="text" id="newPlayerName" placeholder="è¾“å…¥ç©å®¶åç§°">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="addPlayerBtn">æ·»åŠ </button>
                <button class="btn btn-primary" id="selectPlayerBtn">é€‰æ‹©</button>
                <button class="btn btn-primary" id="cancelSelectBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç»“ç®—æ¨¡æ€æ¡† -->
    <div class="modal" id="settlementModal">
        <div class="modal-content">
            <div class="modal-title">ç»“ç®—</div>
            <div class="settlement-area" id="settlementArea">
                <p style="text-align: center; color: #999; margin-bottom: 15px;">
                    ç‚¹å‡»ç©å®¶é€‰æ‹©"ä»"ï¼Œå†ç‚¹å‡»å¦ä¸€ä¸ªç©å®¶é€‰æ‹©"åˆ°"ï¼Œæˆ–æ‹–åŠ¨ç©å®¶åå­—
                </p>
                <div id="settlementPlayers"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="completeSettlementBtn">å®Œæˆç»“ç®—</button>
                <button class="btn btn-primary" id="cancelSettlementBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è¾“å…¥åˆ†æ•°æ¨¡æ€æ¡† -->
    <div class="modal" id="amountModal">
        <div class="modal-content">
            <div class="modal-title" id="amountTitle">è¾“å…¥åˆ†æ•°</div>
            <div class="input-group">
                <label id="amountLabel">ä» <span id="fromPlayerName"></span> ç»™ <span id="toPlayerName"></span></label>
                <input type="number" id="amountInput" placeholder="è¾“å…¥åˆ†æ•°" min="0" step="1">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="confirmAmountBtn">ç¡®è®¤</button>
                <button class="btn btn-primary" id="cancelAmountBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">è®¾ç½®</div>
            <div class="settings-list">
                <div class="settings-item" id="settingsHistory">
                    <div class="settings-item-content">
                        <div class="settings-item-title">å†å²è®°å½•</div>
                        <div class="settings-item-desc">æŸ¥çœ‹æ‰€æœ‰ç»“ç®—å†å²</div>
                    </div>
                </div>
                <div class="settings-item" id="settingsRanking">
                    <div class="settings-item-content">
                        <div class="settings-item-title">æŸ¥çœ‹æ’è¡Œæ¦œ</div>
                        <div class="settings-item-desc">æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åº</div>
                    </div>
                </div>
                <div class="settings-item" id="settingsClearData" style="border-left-color: #e53e3e;">
                    <div class="settings-item-content">
                        <div class="settings-item-title" style="color: #e53e3e;">æ¸…ç©ºæ•°æ®</div>
                        <div class="settings-item-desc" style="color: #999;">åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆä¸å¯æ¢å¤ï¼‰</div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="closeSettingsBtn">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-title">å†å²è®°å½•</div>
            <div id="historyList" style="max-height: 60vh; overflow-y: auto; margin-bottom: 15px;"></div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="closeHistoryBtn">å…³é—­</button>
                <button class="btn btn-secondary" id="clearHistoryBtn" style="background: #e53e3e;">æ¸…ç©ºè®°å½•</button>
            </div>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œæ¨¡æ€æ¡† -->
    <div class="modal" id="rankingModal">
        <div class="modal-content">
            <div class="modal-title">æ’è¡Œæ¦œ</div>
            <div id="rankingList" style="max-height: 60vh; overflow-y: auto; margin-bottom: 15px;"></div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="closeRankingBtn">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®ç®¡ç†
        const gameState = {
            players: [], // æ‰€æœ‰ç©å®¶åˆ—è¡¨ {name: string, score: number}
            seats: [null, null, null, null], // 4ä¸ªåº§ä½ï¼Œå­˜å‚¨ç©å®¶åç§°
            currentRound: 1,
            dealerIndex: 0, // åº„å®¶åº§ä½ç´¢å¼•
            selectedSeat: null, // å½“å‰é€‰æ‹©çš„åº§ä½
            selectedPlayer: null, // å½“å‰é€‰æ‹©çš„ç©å®¶ï¼ˆç”¨äºç»“ç®—ï¼‰
            settlementTransactions: [], // ç»“ç®—äº¤æ˜“ [{from: string, to: string, amount: number}]
            dragSource: null, // æ‹–æ‹½æº
            settlementFrom: null, // ç»“ç®—æ—¶é€‰æ‹©çš„"ä»"ç©å®¶
            history: [] // å†å²è®°å½• [{time: number, round: number, transactions: [{from: string, to: string, amount: number}]}]
        };

        // åˆå§‹åŒ–
        function init() {
            // ç»‘å®šäº‹ä»¶
            document.querySelectorAll('.seat').forEach(seat => {
                seat.addEventListener('click', handleSeatClick);
            });

            document.getElementById('settleBtn').addEventListener('click', openSettlementModal);
            document.getElementById('nextRoundBtn').addEventListener('click', nextRound);
            document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
            document.getElementById('selectPlayerBtn').addEventListener('click', selectPlayer);
            document.getElementById('cancelSelectBtn').addEventListener('click', closePlayerSelectModal);
            document.getElementById('completeSettlementBtn').addEventListener('click', completeSettlement);
            document.getElementById('cancelSettlementBtn').addEventListener('click', closeSettlementModal);
            document.getElementById('confirmAmountBtn').addEventListener('click', confirmAmount);
            document.getElementById('cancelAmountBtn').addEventListener('click', closeAmountModal);
            document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
            document.getElementById('closeSettingsBtn').addEventListener('click', closeSettingsModal);
            document.getElementById('settingsHistory').addEventListener('click', () => {
                closeSettingsModal();
                setTimeout(() => openHistoryModal(), 200);
            });
            document.getElementById('settingsRanking').addEventListener('click', () => {
                closeSettingsModal();
                setTimeout(() => openRankingModal(), 200);
            });
            document.getElementById('settingsClearData').addEventListener('click', () => {
                closeSettingsModal();
                setTimeout(() => clearAllData(), 200);
            });
            document.getElementById('closeHistoryBtn').addEventListener('click', closeHistoryModal);
            document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
            document.getElementById('closeRankingBtn').addEventListener('click', closeRankingModal);
            document.getElementById('newPlayerName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addPlayer();
                }
            });

            // åŠ è½½ä¿å­˜çš„æ•°æ®
            loadGameState();
            updateDisplay();
        }

        // åº§ä½ç‚¹å‡»äº‹ä»¶
        function handleSeatClick(e) {
            const seatElement = e.currentTarget;
            const seatIndex = parseInt(seatElement.dataset.seat);
            gameState.selectedSeat = seatIndex;
            openPlayerSelectModal();
        }

        // æ‰“å¼€é€‰æ‹©ç©å®¶æ¨¡æ€æ¡†
        function openPlayerSelectModal() {
            const modal = document.getElementById('playerSelectModal');
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';

            // è·å–å½“å‰é€‰æ‹©çš„åº§ä½ç´¢å¼•
            const selectedSeatIndex = gameState.selectedSeat;

            // æ˜¾ç¤ºæ‰€æœ‰ç©å®¶ï¼Œä½†è¿‡æ»¤æ‰å·²ç»åœ¨å…¶ä»–åº§ä½ä¸Šçš„ç©å®¶
            gameState.players.forEach((player, index) => {
                // æ£€æŸ¥è¯¥ç©å®¶æ˜¯å¦å·²ç»åœ¨å…¶ä»–åº§ä½ä¸Š
                const isOnSeat = gameState.seats.some((seatPlayer, seatIndex) => {
                    return seatPlayer === player.name && seatIndex !== selectedSeatIndex;
                });

                // å¦‚æœç©å®¶å·²ç»åœ¨å…¶ä»–åº§ä½ä¸Šï¼Œè·³è¿‡
                if (isOnSeat) {
                    return;
                }

                const item = document.createElement('div');
                item.className = 'player-item';
                item.textContent = `${player.name} (${player.score}åˆ†)`;
                item.dataset.index = index;
                item.addEventListener('click', () => {
                    document.querySelectorAll('.player-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    gameState.selectedPlayer = index;
                });
                playerList.appendChild(item);
            });

            modal.classList.add('active');
        }

        // å…³é—­é€‰æ‹©ç©å®¶æ¨¡æ€æ¡†
        function closePlayerSelectModal() {
            document.getElementById('playerSelectModal').classList.remove('active');
            gameState.selectedSeat = null;
            gameState.selectedPlayer = null;
            document.getElementById('newPlayerName').value = '';
        }

        // æ·»åŠ ç©å®¶
        function addPlayer() {
            const input = document.getElementById('newPlayerName');
            const name = input.value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥ç©å®¶åç§°');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (gameState.players.some(p => p.name === name)) {
                alert('è¯¥ç©å®¶å·²å­˜åœ¨');
                return;
            }

            gameState.players.push({ name, score: 0 });
            input.value = '';
            saveGameState();
            openPlayerSelectModal(); // åˆ·æ–°åˆ—è¡¨
        }

        // é€‰æ‹©ç©å®¶
        function selectPlayer() {
            if (gameState.selectedPlayer === null) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç©å®¶æˆ–æ·»åŠ æ–°ç©å®¶');
                return;
            }

            const seatIndex = gameState.selectedSeat;
            const playerIndex = gameState.selectedPlayer;
            const player = gameState.players[playerIndex];

            // è®¾ç½®åº§ä½
            gameState.seats[seatIndex] = player.name;
            
            closePlayerSelectModal();
            updateDisplay();
            saveGameState();
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            // æ›´æ–°åº§ä½æ˜¾ç¤º
            for (let i = 0; i < 4; i++) {
                const seatElement = document.getElementById(`seat-${i}`);
                const nameElement = document.getElementById(`name-${i}`);
                const scoreElement = document.getElementById(`score-${i}`);
                
                const playerName = gameState.seats[i];
                
                if (playerName) {
                    const player = gameState.players.find(p => p.name === playerName);
                    if (player) {
                        nameElement.textContent = player.name;
                        scoreElement.textContent = player.score;
                        nameElement.classList.remove('empty-seat');
                    } else {
                        nameElement.textContent = 'ç‚¹å‡»è®¾ç½®ç©å®¶';
                        nameElement.classList.add('empty-seat');
                        scoreElement.textContent = '0';
                    }
                } else {
                    nameElement.textContent = 'ç‚¹å‡»è®¾ç½®ç©å®¶';
                    nameElement.classList.add('empty-seat');
                    scoreElement.textContent = '0';
                }

                // æ›´æ–°åº„å®¶æ ‡è®°
                if (i === gameState.dealerIndex) {
                    seatElement.classList.add('dealer');
                } else {
                    seatElement.classList.remove('dealer');
                }
            }

            // æ›´æ–°å±€æ•°
            document.getElementById('roundNumber').textContent = gameState.currentRound;
            
            // æ›´æ–°å±€æ•°æ¡†çš„æ—‹è½¬è§’åº¦ï¼Œä½¿å…¶æ­£å¯¹åº„å®¶
            updateRoundCenterRotation();
            
            // æ›´æ–°æ–¹å‘æ ‡è®°
            updateDirectionMarks();
        }
        
        // æ›´æ–°ä¸­é—´å±€æ•°æ¡†çš„æ—‹è½¬è§’åº¦
        function updateRoundCenterRotation() {
            const roundCenter = document.getElementById('roundCenter');
            if (!roundCenter) return;
            
            // æ ¹æ®åº„å®¶ä½ç½®è®¡ç®—æ—‹è½¬è§’åº¦
            // åº§ä½0ï¼ˆbottomï¼‰ï¼š0åº¦
            // åº§ä½1ï¼ˆrightï¼‰ï¼š-90åº¦ï¼ˆé€†æ—¶é’ˆ90åº¦ï¼‰
            // åº§ä½2ï¼ˆtopï¼‰ï¼š180åº¦
            // åº§ä½3ï¼ˆleftï¼‰ï¼š90åº¦ï¼ˆé¡ºæ—¶é’ˆ90åº¦ï¼‰
            let rotation = 0;
            switch(gameState.dealerIndex) {
                case 0: // bottom
                    rotation = 0;
                    break;
                case 1: // right
                    rotation = -90;
                    break;
                case 2: // top
                    rotation = 180;
                    break;
                case 3: // left
                    rotation = 90;
                    break;
            }
            
            roundCenter.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
        }
        
        // æ›´æ–°æ–¹å‘æ ‡è®°
        function updateDirectionMarks() {
            const directions = ['æ±', 'å—', 'è¥¿', 'åŒ—'];
            
            // æ ¹æ®åº„å®¶ä½ç½®è®¡ç®—æ¯ä¸ªåº§ä½çš„æ–¹å‘
            // åº„å®¶æ°¸è¿œæ˜¯æ±ï¼Œé€†æ—¶é’ˆä¾æ¬¡æ˜¯å—ã€è¥¿ã€åŒ—
            for (let i = 0; i < 4; i++) {
                const directionElement = document.getElementById(`direction-${i}`);
                if (!directionElement) continue;
                
                // è®¡ç®—æ–¹å‘ï¼š(åº§ä½ç´¢å¼• - åº„å®¶ç´¢å¼• + 4) % 4
                const directionIndex = (i - gameState.dealerIndex + 4) % 4;
                directionElement.textContent = directions[directionIndex];
                
                // å¦‚æœæ˜¯"æ±"ï¼ˆæ–¹å‘ç´¢å¼•ä¸º0ï¼‰ï¼Œè®¾ç½®ä¸ºçº¢è‰²ï¼Œå¦åˆ™ä¿æŒè“è‰²
                if (directionIndex === 0) {
                    directionElement.style.color = '#ff6b6b';
                } else {
                    directionElement.style.color = '#667eea';
                }
            }
        }

        // ä¸‹ä¸€å±€
        function nextRound() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç©å®¶åœ¨åº§ä½ä¸Š
            const hasPlayers = gameState.seats.some(name => name !== null);
            if (!hasPlayers) {
                alert('è¯·å…ˆè®¾ç½®ç©å®¶');
                return;
            }

            // æ£€æŸ¥å½“å‰å±€æ˜¯å¦æœ‰ç»“ç®—è®°å½•
            const hasSettlement = gameState.history.some(entry => entry.round === gameState.currentRound);
            
            // å¦‚æœæ²¡æœ‰ç»“ç®—è®°å½•ï¼Œå¼¹å‡ºç¡®è®¤æç¤º
            if (!hasSettlement) {
                if (!confirm('ä½ æ²¡æœ‰åšä»»ä½•ç»“ç®—ï¼Œæ˜¯å¦ç¡®å®šè¦è¿›å…¥ä¸‹ä¸€å±€ï¼Ÿ')) {
                    return;
                }
            }

            // åº„å®¶é€†æ—¶é’ˆè½®æ¢ï¼ˆåº§ä½ç´¢å¼• +1ï¼Œæ¨¡4ï¼‰
            gameState.dealerIndex = (gameState.dealerIndex + 1) % 4;
            gameState.currentRound++;
            
            updateDisplay();
            saveGameState();
        }

        // æ‰“å¼€ç»“ç®—æ¨¡æ€æ¡†
        function openSettlementModal() {
            const modal = document.getElementById('settlementModal');
            const playersArea = document.getElementById('settlementPlayers');
            playersArea.innerHTML = '';

            // é‡ç½®ç»“ç®—äº¤æ˜“å’ŒçŠ¶æ€
            gameState.settlementTransactions = [];
            gameState.settlementFrom = null;
            gameState.dragSource = null;

            // æ˜¾ç¤ºå½“å‰åº§ä½ä¸Šçš„ç©å®¶
            const currentPlayers = [];
            for (let i = 0; i < 4; i++) {
                const playerName = gameState.seats[i];
                if (playerName) {
                    const player = gameState.players.find(p => p.name === playerName);
                    if (player) {
                        currentPlayers.push({ name: playerName, seat: i });
                    }
                }
            }

            if (currentPlayers.length === 0) {
                alert('è¯·å…ˆè®¾ç½®ç©å®¶');
                return;
            }

            // åˆ›å»ºå¯æ‹–æ‹½å’Œç‚¹å‡»çš„ç©å®¶åˆ—è¡¨
            createSettlementPlayersList(currentPlayers, playersArea);

            // æ˜¾ç¤ºå·²æœ‰äº¤æ˜“ï¼ˆå¦‚æœæœ‰ï¼‰
            updateSettlementDisplay();

            modal.classList.add('active');
        }

        // åˆ›å»ºç»“ç®—ç©å®¶åˆ—è¡¨
        function createSettlementPlayersList(currentPlayers, playersArea) {
            currentPlayers.forEach(({ name, seat }) => {
                const item = document.createElement('div');
                item.className = 'player-item draggable';
                const player = gameState.players.find(p => p.name === name);
                item.textContent = `${name} (${player ? player.score : 0}åˆ†)`;
                item.dataset.player = name;
                item.draggable = true;
                
                // æ‹–æ‹½äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                item.addEventListener('dragstart', (e) => {
                    gameState.dragSource = name;
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetName = e.currentTarget.dataset.player;
                    if (gameState.dragSource && gameState.dragSource !== targetName) {
                        openAmountModal(gameState.dragSource, targetName);
                        gameState.dragSource = null;
                    }
                });

                // ç‚¹å‡»äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                item.addEventListener('click', () => {
                    if (!gameState.settlementFrom) {
                        // é€‰æ‹©"ä»"ç©å®¶
                        gameState.settlementFrom = name;
                        document.querySelectorAll('#settlementPlayers .player-item').forEach(i => {
                            i.classList.remove('selected');
                            if (i.dataset.player === name) {
                                i.classList.add('selected');
                            }
                        });
                    } else if (gameState.settlementFrom === name) {
                        // å–æ¶ˆé€‰æ‹©
                        gameState.settlementFrom = null;
                        item.classList.remove('selected');
                    } else {
                        // é€‰æ‹©"åˆ°"ç©å®¶
                        openAmountModal(gameState.settlementFrom, name);
                        gameState.settlementFrom = null;
                        document.querySelectorAll('#settlementPlayers .player-item').forEach(i => {
                            i.classList.remove('selected');
                        });
                    }
                });

                playersArea.appendChild(item);
            });
        }

        // æ›´æ–°ç»“ç®—æ˜¾ç¤º
        function updateSettlementDisplay() {
            const area = document.getElementById('settlementArea');
            if (!area) return;
            
            // æ¸…é™¤æ—§çš„äº¤æ˜“æ˜¾ç¤ºï¼ˆä¿ç•™æç¤ºæ–‡å­—å’Œç©å®¶åˆ—è¡¨ï¼‰
            const existingTransactions = area.querySelectorAll('.settlement-item');
            existingTransactions.forEach(item => {
                item.remove();
            });

            // æ˜¾ç¤ºæ‰€æœ‰äº¤æ˜“
            if (gameState.settlementTransactions.length > 0) {
                const transactionsContainer = document.createElement('div');
                transactionsContainer.style.marginTop = '15px';
                transactionsContainer.style.marginBottom = '15px';
                
                gameState.settlementTransactions.forEach((transaction, index) => {
                    const item = document.createElement('div');
                    item.className = 'settlement-item';
                    item.innerHTML = `
                        <div class="from-to">${transaction.from} â†’ ${transaction.to}</div>
                        <div class="amount">${transaction.amount} åˆ†</div>
                        <button class="remove" data-index="${index}">åˆ é™¤</button>
                    `;
                    
                    item.querySelector('.remove').addEventListener('click', () => {
                        gameState.settlementTransactions.splice(index, 1);
                        updateSettlementDisplay();
                    });

                    transactionsContainer.appendChild(item);
                });
                
                // æ’å…¥åˆ°ç©å®¶åˆ—è¡¨ä¹‹å
                const playersArea = document.getElementById('settlementPlayers');
                if (playersArea && playersArea.parentNode) {
                    playersArea.parentNode.insertBefore(transactionsContainer, playersArea.nextSibling);
                }
            }
        }

        // æ‰“å¼€è¾“å…¥åˆ†æ•°æ¨¡æ€æ¡†
        function openAmountModal(from, to) {
            document.getElementById('fromPlayerName').textContent = from;
            document.getElementById('toPlayerName').textContent = to;
            document.getElementById('amountInput').value = '';
            document.getElementById('amountModal').classList.add('active');
        }

        // å…³é—­è¾“å…¥åˆ†æ•°æ¨¡æ€æ¡†
        function closeAmountModal() {
            document.getElementById('amountModal').classList.remove('active');
            gameState.dragSource = null;
        }

        // ç¡®è®¤åˆ†æ•°
        function confirmAmount() {
            const amount = parseInt(document.getElementById('amountInput').value);
            const from = document.getElementById('fromPlayerName').textContent;
            const to = document.getElementById('toPlayerName').textContent;

            if (isNaN(amount) || amount < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
                return;
            }

            if (amount === 0) {
                closeAmountModal();
                return;
            }

            // æ·»åŠ åˆ°äº¤æ˜“åˆ—è¡¨
            gameState.settlementTransactions.push({ from, to, amount });
            updateSettlementDisplay();
            closeAmountModal();
        }

        // å®Œæˆç»“ç®—
        function completeSettlement() {
            if (gameState.settlementTransactions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ç¬”äº¤æ˜“');
                return;
            }

            // åº”ç”¨æ‰€æœ‰äº¤æ˜“
            gameState.settlementTransactions.forEach(transaction => {
                const fromPlayer = gameState.players.find(p => p.name === transaction.from);
                const toPlayer = gameState.players.find(p => p.name === transaction.to);
                
                if (fromPlayer && toPlayer) {
                    fromPlayer.score -= transaction.amount;
                    toPlayer.score += transaction.amount;
                }
            });

            // è®°å½•åˆ°å†å²
            const historyEntry = {
                time: Date.now(),
                round: gameState.currentRound,
                transactions: [...gameState.settlementTransactions]
            };
            gameState.history.unshift(historyEntry); // æ·»åŠ åˆ°å¼€å¤´ï¼Œæœ€æ–°çš„åœ¨å‰é¢

            // æ¸…ç©ºäº¤æ˜“åˆ—è¡¨
            gameState.settlementTransactions = [];
            
            closeSettlementModal();
            updateDisplay();
            saveGameState();
        }

        // å…³é—­ç»“ç®—æ¨¡æ€æ¡†
        function closeSettlementModal() {
            document.getElementById('settlementModal').classList.remove('active');
            gameState.settlementTransactions = [];
            gameState.dragSource = null;
            gameState.settlementFrom = null;
        }

        // æ‰“å¼€å†å²è®°å½•æ¨¡æ€æ¡†
        function openHistoryModal() {
            const modal = document.getElementById('historyModal');
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (gameState.history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— å†å²è®°å½•</p>';
                modal.classList.add('active');
                return;
            }

            // æ˜¾ç¤ºæ‰€æœ‰å†å²è®°å½•
            gameState.history.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'settlement-item';
                item.style.marginBottom = '15px';

                // æ ¼å¼åŒ–æ—¶é—´
                const date = new Date(entry.time);
                const timeStr = date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                let transactionsHtml = '';
                entry.transactions.forEach(trans => {
                    transactionsHtml += `
                        <div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span style="color: #e53e3e;">${trans.from}</span> â†’ 
                            <span style="color: #48bb78;">${trans.to}</span>: 
                            <strong style="color: #667eea;">${trans.amount} åˆ†</strong>
                        </div>
                    `;
                });

                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong style="color: #333;">ç¬¬ ${entry.round} å±€</strong>
                        </div>
                        <div style="font-size: 12px; color: #666;">${timeStr}</div>
                    </div>
                    <div style="background: #f7fafc; padding: 10px; border-radius: 5px;">
                        ${transactionsHtml}
                    </div>
                `;

                historyList.appendChild(item);
            });

            modal.classList.add('active');
        }

        // å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                gameState.history = [];
                saveGameState();
                openHistoryModal(); // åˆ·æ–°æ˜¾ç¤º
            }
        }

        // æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }

        // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // æ‰“å¼€æ’è¡Œæ¦œæ¨¡æ€æ¡†
        function openRankingModal() {
            const modal = document.getElementById('rankingModal');
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';

            if (gameState.players.length === 0) {
                rankingList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— ç©å®¶æ•°æ®</p>';
                modal.classList.add('active');
                return;
            }

            // æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åº
            const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score);

            sortedPlayers.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'settlement-item';
                item.style.marginBottom = '12px';
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.justifyContent = 'space-between';
                item.style.padding = '15px';

                // æ’åå›¾æ ‡
                let rankIcon = '';
                let rankColor = '#667eea';
                if (index === 0) {
                    rankIcon = 'ğŸ¥‡';
                    rankColor = '#ffd700';
                } else if (index === 1) {
                    rankIcon = 'ğŸ¥ˆ';
                    rankColor = '#c0c0c0';
                } else if (index === 2) {
                    rankIcon = 'ğŸ¥‰';
                    rankColor = '#cd7f32';
                }

                item.innerHTML = `
                    <div style="display: flex; align-items: center; flex: 1;">
                        <div style="font-size: 24px; margin-right: 15px; width: 30px; text-align: center;">${rankIcon || (index + 1)}</div>
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${player.name}</div>
                            <div style="font-size: 12px; color: #666;">${index === 0 ? 'æœ€é«˜åˆ†' : ''}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: bold; color: ${rankColor};">${player.score}</div>
                        <div style="font-size: 12px; color: #666;">åˆ†</div>
                    </div>
                `;

                rankingList.appendChild(item);
            });

            modal.classList.add('active');
        }

        // å…³é—­æ’è¡Œæ¦œæ¨¡æ€æ¡†
        function closeRankingModal() {
            document.getElementById('rankingModal').classList.remove('active');
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼ŸåŒ…æ‹¬ç©å®¶ã€åˆ†æ•°ã€å†å²è®°å½•ç­‰æ‰€æœ‰ä¿¡æ¯éƒ½å°†è¢«åˆ é™¤ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
                localStorage.removeItem('mahjongScoreGameState');
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                gameState.players = [];
                gameState.seats = [null, null, null, null];
                gameState.currentRound = 1;
                gameState.dealerIndex = 0;
                gameState.history = [];
                gameState.settlementTransactions = [];
                
                // æ›´æ–°æ˜¾ç¤º
                updateDisplay();
                
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }

        // ä¿å­˜æ¸¸æˆçŠ¶æ€
        function saveGameState() {
            localStorage.setItem('mahjongScoreGameState', JSON.stringify(gameState));
        }

        // åŠ è½½æ¸¸æˆçŠ¶æ€
        function loadGameState() {
            const saved = localStorage.getItem('mahjongScoreGameState');
            if (saved) {
                const savedState = JSON.parse(saved);
                gameState.players = savedState.players || [];
                gameState.seats = savedState.seats || [null, null, null, null];
                gameState.currentRound = savedState.currentRound || 1;
                gameState.dealerIndex = savedState.dealerIndex || 0;
                gameState.history = savedState.history || [];
            }
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
